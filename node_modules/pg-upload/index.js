import fs from 'node:fs'
import { pipeline } from 'node:stream/promises'
import { from } from 'pg-copy-streams'

export async function upload(db, file, sql) {
	const client = await db.connect();
	try {
		const ingestStream = client.query(from(sql))
		const sourceStream = fs.createReadStream(file);
		await pipeline(sourceStream, ingestStream);
	} finally {
		client.release();
	}
}
